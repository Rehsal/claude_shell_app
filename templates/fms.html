<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMS Programmer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            background: #0f3460;
            border-bottom: 1px solid #374151;
            flex-shrink: 0;
        }

        .top-bar h1 { font-size: 1.1rem; color: #e94560; margin-right: 8px; }
        .spacer { flex: 1; }

        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #f87171;
            display: inline-block;
        }
        .status-dot.connected { background: #4ade80; }

        .conn-text { color: #94a3b8; font-size: 0.8rem; }
        .conn-text.connected { color: #4ade80; }

        .runner-badge {
            font-size: 0.8rem; font-weight: 600;
            padding: 3px 10px; border-radius: 4px;
        }
        .runner-badge.idle { color: #94a3b8; background: #374151; }
        .runner-badge.running { color: #4ade80; background: rgba(74,222,128,0.15); }
        .runner-badge.completed { color: #4ade80; background: rgba(74,222,128,0.2); }
        .runner-badge.error { color: #f87171; background: rgba(248,113,113,0.15); }
        .runner-badge.stopped { color: #fbbf24; background: rgba(251,191,36,0.15); }

        .btn {
            padding: 6px 14px; border: none; border-radius: 5px;
            cursor: pointer; font-size: 0.8rem; font-weight: 500; color: white;
        }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .btn-primary { background: #e94560; }
        .btn-primary:hover:not(:disabled) { background: #ff6b6b; }
        .btn-secondary { background: #374151; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-success { background: #10b981; }
        .btn-success:hover:not(:disabled) { background: #34d399; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover:not(:disabled) { background: #f87171; }
        .btn-warning { background: #f59e0b; }
        .btn-warning:hover:not(:disabled) { background: #fbbf24; }

        .main-content {
            display: flex; flex: 1; overflow: hidden;
        }

        /* Left Panel */
        .left-panel {
            width: 380px; min-width: 320px;
            display: flex; flex-direction: column;
            border-right: 1px solid #374151;
            background: #16213e;
        }

        .panel-section {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
        }
        .panel-section h3 {
            font-size: 0.85rem; color: #94a3b8;
            margin-bottom: 8px; text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fetch-row {
            display: flex; gap: 8px;
        }
        .fetch-row input {
            flex: 1; padding: 6px 10px;
            background: #1a1a2e; border: 1px solid #374151;
            border-radius: 4px; color: #fff; font-size: 0.85rem;
        }

        .ofp-summary {
            font-size: 0.8rem; line-height: 1.6;
            color: #d1d5db;
        }
        .ofp-summary .label { color: #94a3b8; }
        .ofp-summary .value { color: #4ade80; font-weight: 500; }
        .ofp-summary .route-str {
            color: #94a3b8; font-size: 0.75rem;
            word-break: break-all; margin-top: 4px;
        }

        .sequence-hint {
            font-size: 0.7rem; color: #6b7280;
            margin-bottom: 6px; font-style: italic;
        }

        .page-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        .page-buttons .btn { font-size: 0.75rem; padding: 8px 6px; }
        .btn-program-all {
            grid-column: 1 / -1;
            background: #10b981 !important;
            font-size: 0.85rem !important;
            padding: 10px !important;
        }

        /* Page button status styles */
        .page-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .page-btn.status-running {
            border-color: #4ade80;
            animation: pulse-border 1.2s ease-in-out infinite;
        }
        .page-btn.status-completed {
            background: #166534 !important;
            border-color: #4ade80;
        }
        .page-btn.status-completed:hover:not(:disabled) {
            background: #15803d !important;
        }
        .page-btn.status-error {
            background: #7f1d1d !important;
            border-color: #f87171;
        }
        .page-btn.status-error:hover:not(:disabled) {
            background: #991b1b !important;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #4ade80; box-shadow: 0 0 4px rgba(74,222,128,0.3); }
            50% { border-color: #86efac; box-shadow: 0 0 12px rgba(74,222,128,0.6); }
        }

        .progress-bar {
            height: 4px; background: #374151;
            border-radius: 2px; margin-top: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #4ade80;
            transition: width 0.3s;
            width: 0%;
        }

        .action-row {
            display: flex; gap: 6px;
        }
        .action-row .btn { flex: 1; }

        /* Right Panel */
        .right-panel {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* CDU Display */
        .cdu-container {
            padding: 16px;
            display: flex; justify-content: center;
            flex-shrink: 0;
        }
        .cdu-screen {
            background: #000;
            border: 2px solid #374151;
            border-radius: 8px;
            padding: 12px 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #00ff00;
            min-height: 260px;
            width: 420px;
            white-space: pre;
        }
        .cdu-screen .scratchpad {
            border-top: 1px solid #333;
            padding-top: 4px;
            margin-top: 4px;
            color: #ffffff;
        }

        /* Log Panel */
        .log-panel {
            flex: 1; overflow-y: auto;
            padding: 12px 16px;
            border-top: 1px solid #374151;
            background: #111827;
        }
        .log-panel h3 {
            font-size: 0.8rem; color: #94a3b8;
            margin-bottom: 8px; text-transform: uppercase;
        }
        .log-entry {
            font-family: monospace;
            font-size: 0.75rem;
            color: #9ca3af;
            line-height: 1.5;
        }
        .log-entry.section { color: #22d3ee; font-weight: 600; }
        .log-entry.error { color: #f87171; }
        .log-entry.warning { color: #fbbf24; }
        .log-entry.success { color: #4ade80; }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>FMS Programmer</h1>
        <span class="status-dot" id="connDot"></span>
        <span class="conn-text" id="connText">Disconnected</span>
        <span class="spacer"></span>
        <span class="runner-badge idle" id="stateBadge">IDLE</span>
        <a href="/checklist" class="btn btn-secondary" style="text-decoration:none">Checklist</a>
    </div>

    <div class="main-content">
        <div class="left-panel">
            <!-- SimBrief Fetch -->
            <div class="panel-section">
                <h3>SimBrief OFP</h3>
                <div class="fetch-row">
                    <input type="text" id="pilotId" placeholder="Pilot ID">
                    <button class="btn btn-primary" id="fetchBtn" onclick="fetchSimbrief()">Fetch</button>
                </div>
                <div class="ofp-summary" id="ofpSummary" style="margin-top:10px; display:none;"></div>
            </div>

            <!-- Page Buttons -->
            <div class="panel-section">
                <h3>Program Pages</h3>
                <div class="sequence-hint">Recommended sequence (top-left to bottom-right)</div>
                <div class="page-buttons">
                    <button class="btn btn-secondary page-btn" onclick="programPage('pos_init')" id="btn_pos_init">1. POS INIT</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('uplink')" id="btn_uplink">2. UPLINK</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('init_ref')" id="btn_init_ref">3. INIT REF</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('route')" id="btn_route">4. ROUTE</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('dep_arr')" id="btn_dep_arr">5. DEP/ARR</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('perf_init')" id="btn_perf_init">6. PERF INIT</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('n1_limit')" id="btn_n1_limit">7. N1 LIMIT</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('takeoff_ref')" id="btn_takeoff_ref">8. TAKEOFF REF</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('vnav')" id="btn_vnav">9. VNAV</button>
                    <button class="btn btn-secondary page-btn" onclick="programPage('legs')" id="btn_legs">10. LEGS</button>
                    <button class="btn btn-program-all" onclick="programAll()" id="btnProgramAll">Program All</button>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            </div>

            <!-- Stop / Clear -->
            <div class="panel-section">
                <div class="action-row">
                    <button class="btn btn-danger" onclick="stopProgramming()">Stop</button>
                    <button class="btn btn-warning" onclick="clearFMS()">Clear FMS</button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <!-- CDU Screen -->
            <div class="cdu-container">
                <div class="cdu-screen" id="cduScreen">
                    CDU not connected
                </div>
            </div>

            <!-- Log -->
            <div class="log-panel" id="logPanel">
                <h3>Log</h3>
                <div id="logContent"></div>
            </div>
        </div>
    </div>

    <script>
        let statusTimer = null;
        let screenTimer = null;
        let isRunning = false;
        let lastLogLen = 0;
        let pageQueue = [];
        let wasRunning = false;

        // Map of backend page names to button IDs
        const PAGE_BUTTONS = {
            'pos_init': 'btn_pos_init',
            'uplink': 'btn_uplink',
            'efb_load': 'btn_uplink',  // _run_all uses "efb_load" for uplink
            'init_ref': 'btn_init_ref',
            'route': 'btn_route',
            'dep_arr': 'btn_dep_arr',
            'perf_init': 'btn_perf_init',
            'n1_limit': 'btn_n1_limit',
            'takeoff_ref': 'btn_takeoff_ref',
            'vnav': 'btn_vnav',
            'legs': 'btn_legs',
        };

        // Load saved pilot ID
        const savedPid = localStorage.getItem('fms_pilot_id') || '';
        document.getElementById('pilotId').value = savedPid;

        // Check for cached data on load
        checkCachedData();

        // Start polling
        startPolling();

        async function fetchSimbrief() {
            const pid = document.getElementById('pilotId').value.trim();
            if (!pid) return alert('Enter a SimBrief Pilot ID');
            localStorage.setItem('fms_pilot_id', pid);

            const btn = document.getElementById('fetchBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';

            try {
                const body = new URLSearchParams({ pilot_id: pid });
                const resp = await fetch('/api/fms/simbrief/fetch', { method: 'POST', body });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.detail || 'Fetch failed');
                showOFP(data);
            } catch (e) {
                alert('SimBrief error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Fetch';
            }
        }

        async function checkCachedData() {
            try {
                const resp = await fetch('/api/fms/simbrief/data');
                const data = await resp.json();
                if (data.status === 'ok') showOFP(data);
            } catch (e) {}
        }

        function showOFP(d) {
            const el = document.getElementById('ofpSummary');
            el.style.display = 'block';
            el.innerHTML = `
                <div><span class="label">Route:</span> <span class="value">${d.origin} â†’ ${d.destination}</span></div>
                <div><span class="label">Flight:</span> <span class="value">${d.flight_number || 'N/A'}</span></div>
                <div><span class="label">FL:</span> <span class="value">${Math.round((d.cruise_altitude||0)/100)}</span>
                     <span class="label" style="margin-left:12px">CI:</span> <span class="value">${d.cost_index}</span></div>
                <div><span class="label">ZFW:</span> <span class="value">${d.zfw?.toLocaleString() || '?'}</span>
                     <span class="label" style="margin-left:12px">Fuel:</span> <span class="value">${d.fuel_block?.toLocaleString() || '?'}</span></div>
                <div><span class="label">PAX:</span> <span class="value">${d.pax_count || '?'}</span>
                     <span class="label" style="margin-left:12px">Flaps:</span> <span class="value">${d.flap_setting || '?'}</span></div>
                ${d.v1 ? `<div><span class="label">V1:</span> <span class="value">${d.v1}</span>
                     <span class="label" style="margin-left:8px">VR:</span> <span class="value">${d.vr}</span>
                     <span class="label" style="margin-left:8px">V2:</span> <span class="value">${d.v2}</span></div>` : ''}
                ${d.sid ? `<div><span class="label">SID:</span> <span class="value">${d.sid}</span></div>` : ''}
                ${d.star ? `<div><span class="label">STAR:</span> <span class="value">${d.star}</span></div>` : ''}
                <div><span class="label">Waypoints:</span> <span class="value">${d.navlog_count || 0}</span></div>
                ${d.route ? `<div class="route-str">${d.route}</div>` : ''}
            `;
        }

        async function programAll() {
            try {
                const resp = await fetch('/api/fms/program', { method: 'POST' });
                const data = await resp.json();
                if (!resp.ok) alert(data.detail || 'Start failed');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function programPage(page) {
            if (isRunning) {
                // Queue it if not already queued
                if (!pageQueue.includes(page)) {
                    pageQueue.push(page);
                    // Show queued button with running style as preview
                    const btnId = PAGE_BUTTONS[page];
                    if (btnId) document.getElementById(btnId)?.classList.add('status-running');
                }
                return;
            }
            try {
                const resp = await fetch(`/api/fms/program/${page}`, { method: 'POST' });
                const data = await resp.json();
                if (!resp.ok) alert(data.detail || 'Start failed');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function processQueue() {
            if (pageQueue.length === 0) return;
            const next = pageQueue.shift();
            try {
                const resp = await fetch(`/api/fms/program/${next}`, { method: 'POST' });
                const data = await resp.json();
                if (!resp.ok) pageQueue = []; // Clear queue on error
            } catch (e) {
                pageQueue = [];
            }
        }

        async function stopProgramming() {
            pageQueue = [];
            try {
                await fetch('/api/fms/stop', { method: 'POST' });
            } catch (e) {}
        }

        async function clearFMS() {
            pageQueue = [];
            try {
                // Reset programmer state only (no CDU commands)
                await fetch('/api/fms/reset', { method: 'POST' });
                resetPageButtons();
                lastLogLen = 0;
                document.getElementById('logContent').innerHTML = '';
                document.getElementById('progressFill').style.width = '0%';
            } catch (e) {}
        }

        function resetPageButtons() {
            document.querySelectorAll('.page-btn').forEach(btn => {
                btn.classList.remove('status-running', 'status-completed', 'status-error');
            });
        }

        function updatePageButtons(pageResults) {
            if (!pageResults) return;
            // First reset all
            document.querySelectorAll('.page-btn').forEach(btn => {
                btn.classList.remove('status-running', 'status-completed', 'status-error');
            });
            // Apply current results
            for (const [page, status] of Object.entries(pageResults)) {
                const btnId = PAGE_BUTTONS[page];
                if (!btnId) continue;
                const btn = document.getElementById(btnId);
                if (!btn) continue;
                if (status === 'running') {
                    btn.classList.add('status-running');
                } else if (status === 'completed') {
                    btn.classList.add('status-completed');
                } else if (status === 'error') {
                    btn.classList.add('status-error');
                }
            }
        }

        function startPolling() {
            statusTimer = setInterval(pollStatus, 500);
            screenTimer = setInterval(pollScreen, 500);
        }

        async function pollStatus() {
            try {
                const resp = await fetch('/api/fms/status');
                const s = await resp.json();
                updateStatus(s);
            } catch (e) {}
        }

        function updateStatus(s) {
            const badge = document.getElementById('stateBadge');
            badge.textContent = s.state.toUpperCase();
            badge.className = 'runner-badge ' + s.state;

            document.getElementById('progressFill').style.width = s.progress + '%';

            isRunning = s.state === 'running';

            // When programmer finishes and there are queued pages, start next
            if (wasRunning && !isRunning && pageQueue.length > 0) {
                processQueue();
            }
            wasRunning = isRunning;

            // Update page button statuses
            updatePageButtons(s.page_results);

            // Update log
            const logEl = document.getElementById('logContent');
            if (s.log && s.log.length !== lastLogLen) {
                lastLogLen = s.log.length;
                logEl.innerHTML = s.log.map(l => {
                    let cls = 'log-entry';
                    const lower = l.toLowerCase();
                    if (l.startsWith('---')) cls += ' section';
                    else if (lower.includes('error') || lower.includes('fatal')) cls += ' error';
                    else if (lower.includes('warning') || lower.includes('could not')) cls += ' warning';
                    else if (lower.includes('complete') || lower.includes('done') || lower.includes('success')) cls += ' success';
                    return `<div class="${cls}">${escHtml(l)}</div>`;
                }).join('');
                // Auto-scroll
                const panel = document.getElementById('logPanel');
                panel.scrollTop = panel.scrollHeight;
            }
        }

        async function pollScreen() {
            try {
                const resp = await fetch('/api/fms/cdu/screen');
                const s = await resp.json();
                updateCDU(s);
            } catch (e) {}
        }

        function updateCDU(s) {
            const dot = document.getElementById('connDot');
            const txt = document.getElementById('connText');
            dot.className = 'status-dot' + (s.connected ? ' connected' : '');
            txt.className = 'conn-text' + (s.connected ? ' connected' : '');
            txt.textContent = s.connected ? 'Connected' : 'Disconnected';

            if (!s.connected || !s.lines) {
                document.getElementById('cduScreen').textContent = 'CDU not connected';
                return;
            }

            let html = s.lines.map(l => escHtml(l || '')).join('\n');
            if (s.scratchpad) {
                html += `\n<span class="scratchpad">${escHtml(s.scratchpad)}</span>`;
            }
            document.getElementById('cduScreen').innerHTML = html;
        }

        function escHtml(t) {
            return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }
    </script>
</body>
</html>
